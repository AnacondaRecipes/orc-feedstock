From 062163105fe3daa8f334083d1616622fec30a54a Mon Sep 17 00:00:00 2001
From: Michael Sarahan <msarahan@gmail.com>
Date: Mon, 9 Apr 2018 15:01:30 -0500
Subject: [PATCH] cmake rework

---
 CMakeLists.txt            | 38 +++++++++++++++-----------------------
 c++/libs/CMakeLists.txt   |  8 ++++----
 c++/src/CMakeLists.txt    |  6 +++---
 c++/test/CMakeLists.txt   |  6 +++---
 tools/src/CMakeLists.txt  | 14 +++++++-------
 tools/test/CMakeLists.txt |  4 ++--
 6 files changed, 34 insertions(+), 42 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 95fd49c..310e810 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -47,27 +47,19 @@ if(NOT APPLE AND NOT MSVC)
   list (APPEND GMOCK_LIBRARIES pthread)
 endif(NOT APPLE AND NOT MSVC)
 
-set (LZ4_VERSION "r131")
-set (LZ4_INCLUDE_DIRS "${CMAKE_SOURCE_DIR}/c++/libs/lz4-${LZ4_VERSION}/lib")
-set (LZ4_LIBRARIES lz4)
-
-set (PROTOBUF_VERSION "2.6.0")
-set (PROTOBUF_INCLUDE_DIRS
-     "${CMAKE_SOURCE_DIR}/c++/libs/protobuf-${PROTOBUF_VERSION}/src")
-set (PROTOBUF_LIBRARIES protobuf)
-set (PROTOBUF_EXECUTABLE "${CMAKE_BINARY_DIR}/c++/libs/protobuf-${PROTOBUF_VERSION}/protoc")
-
-set (SNAPPY_VERSION "1.1.2")
-set (SNAPPY_INCLUDE_DIRS
-     "${CMAKE_SOURCE_DIR}/c++/libs/snappy-${SNAPPY_VERSION}")
-set (SNAPPY_LIBRARIES snappy)
-
-set (ZLIB_VERSION "1.2.8")
-set (ZLIB_INCLUDE_DIRS
-     "${CMAKE_SOURCE_DIR}/c++/libs/zlib-${ZLIB_VERSION}"
-     "${CMAKE_BINARY_DIR}/c++/libs/zlib-${ZLIB_VERSION}"
-    )
-set (ZLIB_LIBRARIES zlib)
+find_package(Protobuf REQUIRED)
+
+find_path(SNAPPY_INCLUDE_DIRS NAMES snappy.h PATHS ${PREFIX}/include)
+find_library(SNAPPY_LIBRARIES NAMES snappy PATHS ${PREFIX}/lib)
+include(FindPackageHandleStandardArgs)
+find_package_handle_standard_args(Snappy DEFAULT_MSG SNAPPY_INCLUDE_DIRS SNAPPY_LIBRARIES)
+
+find_path(LZ4_INCLUDE_DIRS NAMES lz4.h PATHS ${PREFIX}/include)
+find_library(LZ4_LIBRARIES NAMES lz4 PATHS ${PREFIX}/lib)
+include(FindPackageHandleStandardArgs)
+find_package_handle_standard_args(LZ4 DEFAULT_MSG LZ4_INCLUDE_DIRS LZ4_LIBRARIES)
+
+find_package(zlib REQUIRED)
 
 #
 # Compiler specific flags
@@ -82,9 +74,9 @@ if (CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
   set (WARN_FLAGS "${WARN_FLAGS} -Wno-c++98-compat-pedantic -Wno-padded")
   set (WARN_FLAGS "${WARN_FLAGS} -Wno-covered-switch-default")
   set (WARN_FLAGS "${WARN_FLAGS} -Wno-missing-noreturn -Wno-unknown-pragmas")
-  set (WARN_FLAGS "${WARN_FLAGS} -Wconversion -Werror")
+  set (WARN_FLAGS "${WARN_FLAGS} -Wconversion")
 elseif (CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
-  set (WARN_FLAGS "-Wall -Wno-unknown-pragmas -Wconversion -Werror")
+  set (WARN_FLAGS "-Wall -Wno-unknown-pragmas -Wconversion")
   if (CMAKE_CXX_COMPILER_VERSION STREQUAL "" OR
       CMAKE_CXX_COMPILER_VERSION VERSION_LESS "4.7")
     set (CXX11_FLAGS "-std=c++0x")
diff --git a/c++/libs/CMakeLists.txt b/c++/libs/CMakeLists.txt
index e298f0d..27d69df 100644
--- a/c++/libs/CMakeLists.txt
+++ b/c++/libs/CMakeLists.txt
@@ -19,7 +19,7 @@ if (CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
 endif ()
 
 add_subdirectory(gmock-${GMOCK_VERSION})
-add_subdirectory(zlib-${ZLIB_VERSION})
-add_subdirectory(protobuf-${PROTOBUF_VERSION})
-add_subdirectory(snappy-${SNAPPY_VERSION})
-add_subdirectory(lz4-${LZ4_VERSION})
+# add_subdirectory(zlib-${ZLIB_VERSION})
+# add_subdirectory(protobuf-${PROTOBUF_VERSION})
+# add_subdirectory(snappy-${SNAPPY_VERSION})
+# add_subdirectory(lz4-${LZ4_VERSION})
diff --git a/c++/src/CMakeLists.txt b/c++/src/CMakeLists.txt
index d717fb4..cbaa2bd 100644
--- a/c++/src/CMakeLists.txt
+++ b/c++/src/CMakeLists.txt
@@ -119,14 +119,14 @@ configure_file (
 include_directories (
   ${CMAKE_CURRENT_SOURCE_DIR}
   ${CMAKE_CURRENT_BINARY_DIR}
-  ${PROTOBUF_INCLUDE_DIRS}
+  ${Protobuf_INCLUDE_DIRS}
   ${ZLIB_INCLUDE_DIRS}
   ${SNAPPY_INCLUDE_DIRS}
   ${LZ4_INCLUDE_DIRS}
   )
 
 add_custom_command(OUTPUT orc_proto.pb.h orc_proto.pb.cc
-   COMMAND ${PROTOBUF_EXECUTABLE}
+   COMMAND ${Protobuf_PROTOC_EXECUTABLE}
         -I ${CMAKE_SOURCE_DIR}/proto
         --cpp_out="${CMAKE_CURRENT_BINARY_DIR}"
         "${CMAKE_SOURCE_DIR}/proto/orc_proto.proto"
@@ -159,7 +159,7 @@ add_library (orc STATIC
 install(TARGETS orc DESTINATION lib)
 
 target_link_libraries (orc
-  ${PROTOBUF_LIBRARIES}
+  ${Protobuf_LIBRARIES}
   ${ZLIB_LIBRARIES}
   ${SNAPPY_LIBRARIES}
   ${LZ4_LIBRARIES}
diff --git a/c++/test/CMakeLists.txt b/c++/test/CMakeLists.txt
index 83c48a3..059505c 100644
--- a/c++/test/CMakeLists.txt
+++ b/c++/test/CMakeLists.txt
@@ -14,7 +14,7 @@ include_directories(
   ${PROJECT_SOURCE_DIR}/c++/src
   ${PROJECT_BINARY_DIR}/c++/include
   ${PROJECT_BINARY_DIR}/c++/src
-  ${PROTOBUF_INCLUDE_DIRS}
+  ${Protobuf_INCLUDE_DIRS}
   ${ZLIB_INCLUDE_DIRS}
   ${SNAPPY_INCLUDE_DIRS}
   ${GMOCK_INCLUDE_DIRS}
@@ -40,7 +40,7 @@ target_link_libraries (orc-test
   orc
   ${GMOCK_LIBRARIES}
   ${LZ4_LIBRARIES}
-  ${PROTOBUF_LIBRARIES}
+  ${Protobuf_LIBRARIES}
   ${SNAPPY_LIBRARIES}
   ${ZLIB_LIBRARIES}
 )
@@ -51,7 +51,7 @@ add_executable (create-test-files
 
 target_link_libraries (create-test-files
   orc
-  ${PROTOBUF_LIBRARIES}
+  ${Protobuf_LIBRARIES}
 )
 
 add_test (NAME orc-test COMMAND orc-test)
diff --git a/tools/src/CMakeLists.txt b/tools/src/CMakeLists.txt
index 0fc5f64..330373e 100644
--- a/tools/src/CMakeLists.txt
+++ b/tools/src/CMakeLists.txt
@@ -15,7 +15,7 @@ include_directories (
   ${PROJECT_SOURCE_DIR}/c++/src
   ${PROJECT_BINARY_DIR}/c++/include
   ${PROJECT_BINARY_DIR}/c++/src
-  ${PROTOBUF_INCLUDE_DIRS}
+  ${Protobuf_INCLUDE_DIRS}
   )
 
 set (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g ${CXX11_FLAGS} ${WARN_FLAGS}")
@@ -26,7 +26,7 @@ add_executable (orc-contents
 
 target_link_libraries (orc-contents
   orc
-  ${PROTOBUF_LIBRARIES}
+  ${Protobuf_LIBRARIES}
   )
 
 add_executable (orc-scan
@@ -35,7 +35,7 @@ add_executable (orc-scan
 
 target_link_libraries (orc-scan
   orc
-  ${PROTOBUF_LIBRARIES}
+  ${Protobuf_LIBRARIES}
   )
 
 add_executable (orc-metadata
@@ -44,7 +44,7 @@ add_executable (orc-metadata
 
 target_link_libraries (orc-metadata
   orc
-  ${PROTOBUF_LIBRARIES}
+  ${Protobuf_LIBRARIES}
   )
 
  add_executable (orc-statistics
@@ -53,7 +53,7 @@ target_link_libraries (orc-metadata
 
 target_link_libraries (orc-statistics
   orc
-  ${PROTOBUF_LIBRARIES}
+  ${Protobuf_LIBRARIES}
   )
 
 add_executable (orc-memory
@@ -62,7 +62,7 @@ add_executable (orc-memory
 
 target_link_libraries (orc-memory
   orc
-  ${PROTOBUF_LIBRARIES}
+  ${Protobuf_LIBRARIES}
   )
 
 add_executable (timezone-dump
@@ -71,7 +71,7 @@ add_executable (timezone-dump
 
 target_link_libraries (timezone-dump
   orc
-  ${PROTOBUF_LIBRARIES}
+  ${Protobuf_LIBRARIES}
   )
 
 install(TARGETS
diff --git a/tools/test/CMakeLists.txt b/tools/test/CMakeLists.txt
index 36d9b2f..c872959 100644
--- a/tools/test/CMakeLists.txt
+++ b/tools/test/CMakeLists.txt
@@ -16,7 +16,7 @@ include_directories(
   ${PROJECT_SOURCE_DIR}/tools-c++/src
   ${PROJECT_BINARY_DIR}/c++/include
   ${PROJECT_BINARY_DIR}/c++/src
-  ${PROTOBUF_INCLUDE_DIRS}
+  ${Protobuf_INCLUDE_DIRS}
   ${ZLIB_INCLUDE_DIRS}
   ${GMOCK_INCLUDE_DIRS}
 )
@@ -33,7 +33,7 @@ add_executable (tool-test
 
 target_link_libraries (tool-test
   orc
-  ${PROTOBUF_LIBRARIES}
+  ${Protobuf_LIBRARIES}
   ${GMOCK_LIBRARIES}
   ${ZLIB_LIBRARIES}
   ${SNAPPY_LIBRARIES}
-- 
2.11.1

